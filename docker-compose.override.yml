version: "3.8"

services:
  # VBank DB
  db_vbank:
    image: postgres:15-alpine
    container_name: mybank-db-vbank
    env_file:
      - .env.vbank
    volumes:
      - postgres_data_vbank:/var/lib/postgresql/data
      - ./shared/database/init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ./shared/database/bank_settings_vbank.sql:/docker-entrypoint-initdb.d/02_bank_settings.sql:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bankuser} -d ${POSTGRES_DB:-mybank_db_vbank}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # ABank DB
  db_abank:
    image: postgres:15-alpine
    container_name: mybank-db-abank
    env_file:
      - .env.abank
    volumes:
      - postgres_data_abank:/var/lib/postgresql/data
      - ./shared/database/init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ./shared/database/bank_settings_abank.sql:/docker-entrypoint-initdb.d/02_bank_settings.sql:ro
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bankuser} -d ${POSTGRES_DB:-mybank_db_abank}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # SBank DB
  db_sbank:
    image: postgres:15-alpine
    container_name: mybank-db-sbank
    env_file:
      - .env.sbank
    volumes:
      - postgres_data_sbank:/var/lib/postgresql/data
      - ./shared/database/init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
      - ./shared/database/bank_settings_sbank.sql:/docker-entrypoint-initdb.d/02_bank_settings.sql:ro
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bankuser} -d ${POSTGRES_DB:-mybank_db_sbank}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Virtual Bank service
  vbank:
    build: .
    container_name: bank-vbank
    env_file:
      - .env.vbank
    ports:
      - "8001:8001"
    depends_on:
      db_vbank:
        condition: service_healthy
    command: sh -c 'until pg_isready -h db_vbank -U ${POSTGRES_USER:-bankuser} -d ${POSTGRES_DB:-mybank_db_vbank}; do echo "Waiting for db_vbank..."; sleep 1; done; exec python run.py'
    volumes:
      - ./shared/keys:/app/shared/keys:ro
      - ./frontend:/app/frontend:ro
    restart: unless-stopped

  # Awesome Bank service
  abank:
    build: .
    container_name: bank-abank
    env_file:
      - .env.abank
    ports:
      - "8002:8002"
    depends_on:
      db_abank:
        condition: service_healthy
    command: sh -c 'until pg_isready -h db_abank -U ${POSTGRES_USER:-bankuser} -d ${POSTGRES_DB:-mybank_db_abank}; do echo "Waiting for db_abank..."; sleep 1; done; exec python run.py'
    volumes:
      - ./shared/keys:/app/shared/keys:ro
      - ./frontend:/app/frontend:ro
    restart: unless-stopped

  # Smart Bank service
  sbank:
    build: .
    container_name: bank-sbank
    env_file:
      - .env.sbank
    ports:
      - "8003:8003"
    depends_on:
      db_sbank:
        condition: service_healthy
    command: sh -c 'until pg_isready -h db_sbank -U ${POSTGRES_USER:-bankuser} -d ${POSTGRES_DB:-mybank_db_sbank}; do echo "Waiting for db_sbank..."; sleep 1; done; exec python run.py'
    volumes:
      - ./shared/keys:/app/shared/keys:ro
      - ./frontend:/app/frontend:ro
    restart: unless-stopped

volumes:
  postgres_data_vbank:
  postgres_data_abank:
  postgres_data_sbank: